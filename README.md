# AF5 export

Скрипт для перемещения данных из одной базы AF5 в другую.

## Использование

### Запуск с утилитой

Загрузить утилиту из [релизов](https://github.com/leha-boltun/af5_export/releases), выбрать, откуда экспортировать, запустить экспорт. Потом выполнить скрипт с результатами экспорта на базе, куда нужно импортировать. 

### Запуск без утилиты

Допустим, необходимо перенести данные (пока только все НР) из базы S в базу D. Для этого нужно выполнить следующие действия:

1. Сделать бэкап базы D,
2. Запустить скрипт af5_export.sql на базе S или D или другой базе с такими же таблицами. Лучше запускать на локальной базе, чтобы не нагружать стенды. Результатом будут строки, которые представляют собой скрипт 2.
3. Запустить скрипт 2 на базе S. Аналогично, результатом будут строки, которые представляют собой скрипт 3.
4. Запустить скрипт 3 на базе D.

Скрипты лучше запускать, не просматривая, так как они довольно большие (например, в psql, DataGrip). Чтобы нормально экспортировать строки в файл в DataGrip, следует выбрать формат TSV и убрать все пункты из File -> Settings -> Database -> CSV Formats -> Quotations.

## Алгоритм работы

Алгоритм работы файла скрипт 3:

1. Запомнить уникальные ключи записей, которые нельзя удалять _(пока неточно)_
2. Удалить все внешние ключи в таблицах
3. Удалить все данные из таблиц D
4. Записать данные из S
5. Обновить связи в данных
6. Обновить данные в записях, ссылающихся на записи, которые нельзя удалять, по уникальным ключам
7. Вернуть внешние ключи в таблицах

Скрипт выполняется в одной транзации, частичные обновления исключены. Единственный побочный эффект — увеличение номеров последовательностей.

Скрипт пока что очень сырой.
